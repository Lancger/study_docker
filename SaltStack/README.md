# 一、salt-master分组
  
  
  ![salt-group-01](https://github.com/Lancger/study_new/blob/master/images/salt-group-01.png)


```
cat > /etc/salt/master << \EOF
 file_recv: True
 file_recv_max_size: 100000
 file_roots:
   base:
     - /srv/salt/
 pillar_roots:
  base:
    - /srv/pillar
 nodegroups:
  ubuntu_all: 'G@os:Ubuntu'
  centos_all: 'G@os:Centos'
  cfd: 'L@node-001,node-002,node-003,node-004,node-005,node-006,node-007'
EOF
systemctl restart salt-master

salt -N centos_all test.ping
```
# 二、salt-master服务器策略
```
cat > /etc/sysconfig/iptables << \EOF
# Generated by iptables-save v1.4.21 on Tue Jun  4 07:20:00 2019
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -s 192.168.56.0/24 -p tcp -m tcp -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
#-A INPUT -p tcp -m state --state NEW -m tcp --dport 4505 -j ACCEPT
#-A INPUT -p tcp -m state --state NEW -m tcp --dport 4506 -j ACCEPT
-A INPUT -p tcp -m multiport --dports 21:25,80,443,33389,9090,3000,10050 -j ACCEPT
-A INPUT -p tcp -m multiport --dports 4505,4506 -j ACCEPT
-A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT
# Completed on Tue Jun  4 07:20:00 2019
EOF

systemctl restart iptables
systemctl status iptables
systemctl restart salt-minion
```

# 三、线上策略
```
cat > /etc/sysconfig/iptables << \EOF
# Generated by iptables-save v1.4.21 on Tue Jun  4 07:20:00 2019
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -s 192.168.52.0/24 -p tcp -m tcp -j ACCEPT
-A INPUT -s 23.244.63.0/24 -p tcp -m tcp -j ACCEPT
#放开salt-master的权限
-A INPUT -s 13.229.223.57/32 -p tcp -m tcp -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
#-A INPUT -p tcp -m state --state NEW -m tcp --dport 3306 -j ACCEPT
-A INPUT -p tcp -m multiport --dports 21:25,80,443,33389,9090,3000,10050 -j ACCEPT
-A INPUT -p tcp -m multiport --dports 4505,4506,8161 -j ACCEPT
-A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT
# Completed on Tue Jun  4 07:20:00 2019
EOF

systemctl restart iptables
systemctl status iptables
systemctl restart supervisord
```

# 四、更换master节点后，minion认证不通过解决办法
```
minion端需要删除旧的master的公钥

sed -i 's/master.*/master: 139.180.210.37/g' /etc/salt/minion
rm  -f /etc/salt/pki/minion/minion_master.pub
systemctl stop supervisord
systemctl disable supervisord
systemctl restart salt-minion
```
参考资料：

https://www.cnblogs.com/lgeng/p/6567424.html    Saltstack 安装配置详解 

https://www.cnblogs.com/hackerer/p/6617301.html  自动化运维之SaltStack实践

https://www.jianshu.com/p/624b9cf51c64  SaltStack学习 

https://www.cnblogs.com/snailshadow/p/8214294.html  saltstack 分组
